#!groovy

def gitInfo = {}

pipeline {
  agent {
    label 'built-in'
   }
  options {
    skipDefaultCheckout()
   }
  
  stages {
     stage('Git checkout') {
       steps {
         script {

           gitinfo = checkout([$class: 'GitSCM', branches: [[name: '${GIT_BRANCH_NAME}']], doGenerateSubmoduleConfigurations: false, extensions: [], gittool: 'Default', submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/vivekcyber/Test4MAS_Nginx.git']]])
           echo "gitInfo: $gitInfo"
          }
       }
     }
     
     stage ('Build & Push Image') {
       steps {
        script {
            echo "Custom docker image built in progress. docker push to artifact repository is ignored for now."
               sh '''
                   docker build -f devops_scripts/dockerfile . -t vivek398951/custom-nginx:latest
                  
                  '''
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-account', passwordVariable: 'DOCKERHUB_PASS', usernameVariable: 'DOCKERHUB_USER')]) {

                    sh ''' docker login -u  ${DOCKERHUB_USER} -p ${DOCKERHUB_PASS} docker.io
                           docker push vivek398951/custom-nginx:latest  
                           docker logout 
                        '''
                    }
                        
            
              }
            }
         }

     stage ('Zip and upload to Artifact repository') {
       steps {
        script {
            sh '''
            cd ${WORKSPACE}/Nginx_K8s_Yaml
            zip -r nginx_yaml.zip *
         '''
          echo "Section to upload to artifactory (Jfrog or Nexus) is not added since there is no artifactory set"
            }
         }
      }
    
    stage ('Scan Image') {
     steps {
      script {
        sh '''
           trivy image custom_nginx:latest

         '''
         }
      }
   }
 }
      post { 
        always { 
            cleanWs()
        }
    }

}
